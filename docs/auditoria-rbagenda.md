# Auditoria rbagenda

## 1. Visão geral da arquitetura de cliente
- Rotas de cliente vivem em `src/app/(client)` com páginas client-side. Layout padrão fornecido por `ClientPageLayout` (`ClientPageShell`, `ClientSection`, `ClientGlassPanel`) e `ClientFullScreenLayout` no layout de `(client)`. `checkout` é exceção: recebe só `LavaLampProvider`. `ClientPageShell` agora pode forçar a classe `force-motion` (com suporte a `#nomotion`) para centralizar o comportamento das animações.
- Fundo animado controlado por `LavaLampProvider` e variáveis CSS globais (`--bg-*`, `--inner-*`, `--glass`, `--glass-stroke`, `--card-stroke`, `--dark`, `--light`, `--lava-alpha-*`); `refreshPalette` redesenha blobs. Classes globais (`client-hero-wrapper`, `page`, `stack`, `glass`, `label`) estão em `globals.css` e agora definem padding vertical mais enxuto (topo 64px + safe-area, base 26px) com gaps menores.
- Páginas sensíveis: `/procedimento`, `/agendamentos`, `/meu-perfil` compartilham hero, vidro e tipografia; `/login` e `/regras` têm observações específicas abaixo. Estilos globais continuam focados em tokens/layout padrão e o que for específico de uma rota fica no CSS Module local.

## 2. Comportamento das páginas sensíveis
### 2.1 `/procedimento` (`src/app/(client)/procedimento/page.tsx`)
- **Objetivo**: fluxo completo de agendamento (tipo → técnica → dia → horário → criação de appointment + início do pagamento de sinal via Stripe).
- **Arquivos e componentes**: rota `page.tsx`; CSS `procedimento.module.css`; subcomponentes em `@components` (`TypeSelectionSection`, `TechniqueSelectionSection`, `DateSelectionSection`, `TimeSelectionSection`, `SummaryBar`, `SummaryModal`, `PayLaterNotice`, `AdminCustomizationPanel`, `ProcedimentoWrapper`, `ProcedimentoCard/Grid/Header`); tipos em `types.ts`.
- **Fluxo de dados/estado**: carrega sessão Supabase e catálogo (`service_types` + assignments + `services`), normaliza preços/duração/buffer. Usa `useClientAvailability` com `subscribe: true`, canal `procedimento-appointments`, buffer/timezone padrão e fallback por `buildAvailabilityData` se erro. Estados: seleção de tipo/técnica/dia/slot, controle de mês, flags de admin/hero, catálogo e modais (summary, pay later). Cria appointment via `/api/appointments` com token; inicia depósito via `/api/payments/create` e redireciona para `/checkout`; “Pagar depois” leva a `/agendamentos`.
- **Layout e UX**: `ProcedimentoWrapper` agora usa `ClientPageShell` + `ClientSection` mantendo a transição `heroReady`; seções de tipo/técnica/dia/horário renderizadas via `ClientGlassPanel` com ícones `LashIcon`; legenda de calendário (available/booked/full/mine/disabled); barra de resumo fixa. Cada etapa ocupa quase a tela inteira (`min-height: calc(100vh - 200px)`) e o espaçamento/âncora entre seções foi ajustado para guiar o scroll com `scroll-margin-top: 140px`. Respeita `prefers-reduced-motion` e força `force-motion` salvo se removido manualmente.
- **Organização**: modularizado em seções e tipos; lógica de disponibilidade isolada no hook; cálculo de slots local usando snapshot. Mantém padrão de outras páginas (shell + glass + lava).
- **Pontos fortes/fracos**: forte clareza do fluxo e reuso de hook; risco em ajustes do buffer/timezone/assinatura de `useClientAvailability` e na criação/pagamento distribuída. Falta testes e centralização de erros.
- **Recomendações**: extrair camada de serviço para pagamentos; validar slots no servidor; adicionar testes de integração para a cadeia tipo→técnica→slot; considerar reutilizar components de resumo em outros fluxos.

### 2.2 `/agendamentos` (`src/app/(client)/agendamentos/page.tsx`)
- **Objetivo**: listar agendamentos, filtrar por status, pagar sinal, cancelar e reagendar respeitando janela de segurança.
- **Arquivos e componentes**: rota `page.tsx`; CSS `agendamentos.module.css`; componentes `AppointmentsHeader`, `StatusFiltersBar`, `AppointmentsList`, `ConfirmCancelModal`, `RescheduleModal`, `BlockedModal`, `SuccessModal`; tipos em `types.ts`.
- **Fluxo de dados/estado**: requer sessão via `useClientSessionGuard` (redirect para `/login` se ausente). Busca `appointments` + `services`/`service_types` + `appointment_payment_totals`; normaliza valores e nomes. Estados de filtro/paginação (ITEMS_PER_PAGE=5), modais de pagamento/cancelamento/bloqueio/sucesso/edição e mensagens. `RescheduleModal` usa `useClientAvailability` (sem subscribe, filtrado por serviço, buffer/timezone padrão, fallback), busca slots via `/api/slots`, bloqueia hoje/passado e horários fora de `CANCEL_THRESHOLD_HOURS` (env ou 24h). Pagamento via `/api/payments/create` → `/checkout`; cancelamento via `/api/appointments/{id}/cancel`; reagendamento via `/api/appointments/{id}/reschedule`.
- **Layout e UX**: shell padrão com painel de vidro e rodapé via `AppointmentsWrapper`; lista mostra status, valores (total/sinal/pago) e badges de depósito; modais usam `ClientBaseModal` compartilhado para backdrop/conteúdo consistentes. Calendário do modal marca `mine/full/booked/available`. O rodapé/mark da página está estilizado apenas no CSS Module (nada mais fica em `globals.css`). Contêineres `.page` e `.pageSection` agora replicam a estrutura de layout do `/procedimento` para centralizar o conteúdo e preservar o respiro do rodapé.
- **Organização**: fluxo dividido em componentes; lógica de disponibilidade encapsulada no hook. Mantém padrão estrutural do shell e redirecionamento de sessão agora feito via hook. Modais compartilham `BaseModal` para evitar duplicação.
- **Pontos fortes/fracos**: boa separação de UI vs. dados; risco em consistência de disponibilidade/buffer; pagamentos e cancelamentos distribuídos sem camada de serviço nem testes; lógica de janela de cancelamento replicada.
- **Recomendações**: unificar tratamento de erros e loading de pagamentos; validar cancelamento/reagendamento também no backend; adicionar testes de paginação e filtros; compartilhar componentes de badge/valor entre lista e modais.

### 2.3 `/meu-perfil` (`src/app/(client)/meu-perfil/page.tsx`)
- **Objetivo**: editar dados pessoais, senha, avatar local e preferências de tema/lava.
- **Arquivos e componentes**: rota `page.tsx`; CSS `meu-perfil.module.css`; `ProfileHeader`, `ProfileForm`, `AvatarUploader`, `ThemePreferencesPanel`; tipos em `types.ts` (`Profile`, `ThemeState`, `defaultTheme`).
- **Fluxo de dados/estado**: `useProfileForm` (envolvendo `useClientSessionGuard`) carrega sessão/perfil (`profiles`), preenche campos e controla salvar/sair; a própria página também chama `useClientSessionGuard` para garantir proteção imediata. Avatar em `localStorage` (`rb_meu_perfil_avatar`). Painel de tema lê vars CSS (`--inner-*`, `--bg-*`, `--glass`, `--glass-stroke`, `--card-stroke`, `--dark`, `--light`, `--lava-alpha-*`), valida/normaliza, aplica via `setProperty` e chama `refreshPalette`; painel só aparece para perfis admin*. Usa `REVEAL_STAGE` para transições e mantém `force-motion`.
- **Layout e UX**: shell padrão com painéis de vidro; header com ações de sign-out; formulário e painel de cor em cartões separados.
- **Organização**: lógica de tema isolada no painel; tipos compartilhados; UI modular. Avatar permanece acoplado ao storage local.
- **Pontos fortes/fracos**: controles de cor completos e alinhados ao lava; risco de valores inválidos quebrando contraste; falta persistência remota do avatar e testes de validação de cor.
- **Recomendações**: validar cores com schema; salvar avatar no servidor; mover lógica de tema para hook compartilhado; cobrir fluxo de salvar perfil com testes e estados de erro.

### 2.4 `/login` (`src/app/(auth)/login/page.tsx`)
- **Objetivo**: autenticar usuário e redirecionar para o destino correto (painéis admin/adminsuper/adminmaster ou `/meu-perfil`).
- **Arquivos e componentes**: rota `page.tsx`; CSS `login.module.css`; usa `ClientPageShell`, `ClientSection`, `ClientGlassPanel` e `LavaLampProvider`.
- **Fluxo de dados/estado**: `supabase.auth.getSession` roda no mount para evitar flicker; se houver sessão, redireciona. `onAuthStateChange` mantém sync. Estados: email, password, msg, `loading`, `checkingSession`; `heroReady` vem de `useClientPageReady`. Enquanto `checkingSession` é true, o formulário permanece visível com aviso (evita “sumir” atrás de skeleton). Submit usa `signInWithPassword`; em sucesso chama `redirectByRole` que consulta `profiles.role` e envia para `/admin` (admin), `/admin/adminsuper` (adminsuper), `/admin/adminmaster` (adminmaster) ou `/meu-perfil` (demais), tratando ausência de sessão com aviso.
- **Layout e UX**: cartão “liquid glass” com logo em pílula, inputs com ícones, botão degradê e links de suporte/signup. Usa shell completo com lava; card centralizado.
- **Organização**: estado todo na página; lógica de sessão encapsulada em hooks Supabase; layout segue padrão de vidro.
- **Pontos fortes/fracos**: fluxo de sessão agora estável (formulário permanece visível); ainda falta feedback granular de erros Supabase e testes de autenticação.
- **Recomendações**: adicionar tratamento de erros por código; validar form antes de submit; mover redirecionamento por role para helper compartilhado.

### 2.5 `/regras` (`src/app/(client)/regras/page.tsx`)
- **Objetivo**: exibir regras públicas da agenda para usuários autenticados.
- **Arquivos e componentes**: rota `page.tsx`; CSS `regras.module.css`; subcomponentes locais em `@components` (`RulesHeader`, `RulesSectionList`, `RulesSectionCard`, `RulesSectionDivider`); tipos em `types.ts`.
- **Fluxo de dados/estado**: protegido por `useClientSessionGuard`; `heroReady` vem de `useClientPageReady`; classe `force-motion` aplicada via `ClientPageShell`.
- **Layout e UX**: usa `ClientPageShell` + `ClientSection` com classes locais (`wrapper`, `pageSection`) para herdar o esqueleto global de spacing/alinhamento, mas **não** usa `ClientGlassPanel`; conteúdo permanece direto no fundo com lava. Ornamento (flourish + diamond) e divisórias brancas entre cards foram preservados. Containers agora esticam para a largura disponível (limites de 720/960px) para evitar shrink-to-fit com `overflow` escondendo linhas em telas estreitas, garantindo quebra natural de texto; reforço de `word-break` evita truncamento em telas menores. O topo e o rodapé usam apenas o padding padrão do shell (64px/26px) sem min-height extra, evitando blocos de fundo vazio.
- **Organização**: modularizada em header, lista e cartões; array de regras tipado para facilitar manutenção sem alterar conteúdo.
- **Pontos fortes/fracos**: clareza visual mantida e alinhamento com padrão de autenticação. Risco baixo; depende apenas do Supabase para sessão.
- **Recomendações**: monitorar responsividade para garantir que textos longos continuem sem truncamento; manter ornamento e ausência de glass em futuros ajustes.

### 2.6 `/suporte` (`src/app/(client)/suporte/page.tsx`)
- **Objetivo**: centralizar canais de atendimento e chat próprio do suporte.
- **Arquivos e componentes**: rota `page.tsx`; CSS `suporte.module.css`; subcomponentes locais `SupportHeader`, `SupportChannelsList`, `SupportChat`, `SupportContent`; tipos em `types.ts`; novo schema Supabase (`support_threads`, `support_messages`).
- **Fluxo de dados/estado**: protegido por `useClientSessionGuard`; `heroReady` vem de `useClientPageReady`; classe `force-motion` aplicada pelo shell. `SupportChat` garante/abre thread ativo do usuário (`support_threads`), carrega histórico (`support_messages`) e insere novas mensagens do cliente enquanto atualiza `last_message_preview/last_actor` do thread.
- **Layout e UX**: usa `ClientPageShell` + `ClientSection` + `ClientGlassPanel` com largura máxima alinhada ao padrão de outras páginas (720px). Canais exibem CTA de WhatsApp (botão preparado para link futuro) e e-mail ainda como “em breve”. O chat agora fica em um botão "CHAT" que abre um painel flutuante estilo WhatsApp, com cabeçalho arrastável, opção de minimizar/fechar, balões com cores diferentes para cliente vs. suporte, área rolável e controles de anexo/emoji; permanece responsivo no mobile.
- **Organização**: canais seguem array tipado; chat encapsula busca/criação de thread e inserção de mensagens com estados locais (`loading/sending`).
- **Recomendações**: adicionar respostas de staff/IA e deep-links de canais reais; considerar listener em tempo real e paginação de mensagens.

### 2.7 `/configuracoes` (`src/app/(client)/configuracoes/page.tsx`)
- **Objetivo**: permitir que a cliente ajuste preferências de contato/notificação.
- **Arquivos e componentes**: rota `page.tsx`; CSS `configuracoes.module.css`; usa `ClientPageShell` + `ClientSection` com header via `ClientPageHeader` e formulário simples.
- **Fluxo de dados/estado**: formulário controlado localmente; protegido por `useClientSessionGuard`; `heroReady` aplicado via hook.
- **Layout e UX**: card centralizado com badge, header padrão e lista de toggles estilizados localmente. Mantém fundo/padding do shell e aplica `force-motion` via shell.
- **Riscos**: mudanças de estilo não afetam lógica; guardar consistência das cores personalizadas nos inputs.

### 2.8 `/indice` (`src/app/(client)/indice/page.tsx`)
- **Objetivo**: hub rápido para links principais.
- **Arquivos e componentes**: rota `page.tsx`; CSS `indice.module.css`; usa `ClientPageShell` + `ClientSection` + `ClientPageHeader`.
- **Fluxo de dados/estado**: protegido por `useClientSessionGuard`; `heroReady` via hook; somente renderiza links estáticos.
- **Layout e UX**: badge + header padrão com cards de links em grade responsiva; vidro claro local nos cartões. Mantém `force-motion` pelo shell para animações consistentes.
- **Riscos**: baixos; apenas grid/responsividade.


## 3. Hooks e helpers compartilhados
- `useClientAvailability` (`src/hooks/useClientAvailability.ts`): recebe `serviceId`, `enabled`, `subscribe`, `channel`, `fallbackBufferMinutes`, `timezone`, mensagem de erro e `initialLoading`. Retorna snapshot de disponibilidade (dias, slots, busy intervals), loading, erro e `reloadAvailability`. Redireciona para `/login` sem sessão, busca `appointments` (status `pending/reserved/confirmed`) de 0–60 dias e inclui buffers por serviço; pode assinar Realtime para recarregar.
- `useClientPageReady` (`src/hooks/useClientPageReady.ts`): aplica classe `client-hero-ready` após mount para liberar animação do shell sem duplicar `useEffect` em cada página.
- `useProfileForm` (`src/app/(client)/meu-perfil/useProfileForm.ts`): carrega sessão/perfil, controla campos, submit e sign-out do `/meu-perfil` com validações compartilhadas.
- Tema/Lava: `useLavaLamp.refreshPalette` usado no painel admin de `/procedimento` e no painel de tema do `/meu-perfil`; `useLavaRevealStage` coordena transições (`heroReady`). Dependem de CSS vars globais.
- Layout: `ClientPageLayout` mantém grid `page`/`stack`, vidro e labels; `ClientFullScreenLayout` injeta header/rodapé; `/regras` é exceção sem painel de vidro. `ClientSection` agora é referência de espaçamento vertical com padding mais curto (64px no topo, 32px na base + safe-area) e sem min-height forçada; páginas que tinham padding próprio (ex.: `/regras`, `/suporte`) herdaram o padrão para alinhar o hero e reduzir fundo vazio.

## 4. Riscos, pontos fracos e oportunidades
- `useClientAvailability` é ponto crítico para `/procedimento` e reagendamento; mudar status/buffer/timezone ou remover redirecionamento pode quebrar slots ou segurança de janela.
- Tema depende de variáveis globais; valores inválidos afetam lava e contraste das páginas sensíveis.
- Fluxo de pagamento (Stripe) é chamado diretamente dos componentes; falta camada de serviço e testes de erro.
- Avatar somente local; risco de perda em novos dispositivos.
- Shell e classes globais são dependências fortes; alterações em `globals.css` impactam todas as páginas.

## 5. Atualizações recentes
- Perfil/Supabase: signup agora envia `full_name` e `whatsapp` como `user_metadata`; `/meu-perfil` lê primeiro da tabela `profiles` e, se não existir, cria/upserta com os metadados (incluindo e-mail) antes de preencher o formulário. A confirmação `/confirm` agora troca o código por sessão com `exchangeCodeForSession` e redireciona direto para `/meu-perfil`, garantindo e-mail sempre preenchido.
- Shell e spacing: padding vertical do shell reduzido (64px topo, 32px base + safe-area) e gaps menores na `.page`; `ClientSection` perdeu min-height forçada para evitar blocos de lava vazios em telas curtas.
- Painel admin: reconstruído do zero no template Xtreme (topbar escura, sidebar lateral fechada mostrando só ícones, cards brancos). Agora existem `/admin` e `/admin/agendamentos`: o primeiro mantém o gráfico com filtros, alternância de tipo (linhas/velas/pizza), atividades, clientes e tickets, enquanto o segundo traz calendário por filial, painel diário com horários ao lado, tabela cronológica e métricas de serviços/tipos (cartões de contagem + distribuição mensal em cartões separados). Não há tema alternável; a filial usada é a atribuída (admins) ou a selecionável futuramente (super/master).
- `/admin`: filtro de período do gráfico agora inclui 60/90 dias, “Todo” e “Personalizado” com datas inicial/final.
- Viewport global: `src/app/layout.tsx` define `viewport` com `width: device-width` e `initialScale: 1`, mantendo os `themeColor` originais para light/dark.
- `/procedimento`: wrapper agora usa `ClientPageShell` + `ClientSection` mantendo hero, sem alterar fluxo ou glass existente, e removeu min-heights/padding duplicados do módulo local. Espaço vertical entre as etapas (tipo → técnica → dia → horário) passou a usar `margin-top` progressiva para separar visualmente cada bloco. Cada seção agora tem altura mínima quase cheia (`min-height: calc(100vh - 200px)`) e âncoras uniformes (`scroll-margin-top: 140px`) para navegação suave.
- `/agendamentos`: redirecionamentos de sessão via `router.replace` (sem reload) mantendo modais/lista; wrapper local sem min-height extra e rodapé/mark agora estilizado apenas no CSS Module (classe global removida). Layout da `.pageSection`/`.page` alinhado ao `/procedimento` para centralizar cartões e dar respiro idêntico ao footer.
- `/meu-perfil`: extratos anteriores mantidos, agora sem min-height custom no wrapper para seguir o shell enxuto.
- `/login`: shell de cliente aplicado; `heroReady` agora via hook e `checkingSession` mostra aviso em vez de esconder o form, evitando flicker.
- Recuperação de senha: novas rotas `/forgot-password` e `/reset-password` usam o mesmo shell/lava das telas de auth. A primeira envia `resetPasswordForEmail` com `redirectTo` para `/reset-password` e exibe confirmação inline; a segunda valida a sessão gerada pelo link, aplica validações básicas (mínimo de 8 caracteres e conferência) e usa `updateUser` para salvar a nova senha antes de direcionar para o login.
- `/admin/agendamentos`: distribuição mensal ajustada com pizza preenchida centralizada, legenda com itens centralizados e quebra automática, filtros em camadas (total/serviços/técnicas → lista + voltar) e labels compactos de período (7D/30D/90D/1A/total/P).
- `/admin/agendamentos`: legenda da distribuição agora usa grid 3x2 alinhada em colunas, garantindo que os itens inferiores (cancelados/reembolsados/concluídos) fiquem verticalmente alinhados aos superiores.
- `/admin/agendamentos`: faixa horizontal para seleção de período agora ocupa toda a largura do card, métricas em grade fixa 2x3, legenda da distribuição exibe valores abaixo do nome e tabela cronológica centralizada. O calendário foi compactado para blocos menores e agora exibe apenas dias do mês atual.
- `/regras`: reforço de quebra de linha para evitar truncamento mantendo ornamentos/divisórias. Padding próprio removido e espaçamento final reduzido para alinhar início do hero ao padrão do shell. Wrapper e section agora usam classes locais (`wrapper`, `pageSection`) para herdar o layout global (cor/centragem) sem mover ornamentos ou vidro.
- `/suporte`: agora protegido por sessão, usa shell completo (lava + glass) e abre com `ClientPageHeader` para alinhar hero e tipografia. Canais modularizados em lista com tipos locais e sem padding custom na section (usa apenas o `ClientSection`). Subtítulo/ajustes visuais vivem no CSS Module.
- Sessão e shell: páginas protegidas usam `useClientSessionGuard` + `useClientPageReady`, eliminando `getSession` duplicado e padronizando a liberação do hero.
- Modais: `ConfirmCancelModal`, `BlockedModal`, `SuccessModal` e `RescheduleModal` agora apoiam-se em `ClientBaseModal` compartilhado em `src/components/client` (usado também no `SummaryModal` do `/procedimento`), reduzindo duplicação de backdrop/estrutura.
- Vidro e variáveis: `agendamentos.module.css` passou a usar apenas variáveis globais (`--ink`, `--muted`, `--card-stroke`, `--glass-stroke`, `--radius-*`) e removeu o bloco `:root` local para manter consistência temática.
- Estrutura `/agendamentos`: página encapsulada por `AppointmentsWrapper` (shell + section) para espelhar o padrão do `/procedimento` sem alterar layout. 
- `/procedimento`: seções principais (tipo, técnica, dia, horário) agora usam `ClientGlassPanel` em vez de divs de vidro locais mantendo rótulos e espaçamento; `SummaryModal` reutiliza `ClientBaseModal`.
- `/meu-perfil`: página também invoca `useClientSessionGuard` diretamente, garantindo proteção além do hook interno do formulário.
- Perfil: lógica de formulário centralizada em `useProfileForm`, mantendo a página focada no layout e temas.
- Força de animação: `ClientPageShell` passou a controlar `force-motion` (com hash `#nomotion`), removendo effects duplicados em `/regras`, `/suporte`, `/meu-perfil` e `/procedimento`.
- `/configuracoes` e `/indice`: agora usam `ClientPageShell` + `ClientSection`, headers padronizados (`ClientPageHeader`), guard de sessão e CSS Modules dedicados.
- Signup: ganhou shell/lava (`ClientPageShell` + `LavaLampProvider`), `ClientGlassPanel` e CSS Module (`signup.module.css`) para alinhar visualmente ao login, mantendo lógica intacta.
- Organização: `rules.module.css` renomeado para `regras.module.css`; criado barrel exports em `agendamentos/@components`, `procedimento/@components` e `regras/@components`; novos CSS Modules (`indice.module.css`) e ajustes no `configuracoes.module.css` para centralizar estilos locais.

## 6. Área administrativa
- Estrutura: duas rotas vivas (`/admin` e `/admin/agendamentos`) sob o shell `AdminShell` + `AdminNav` (`adminShell.module.css`, `adminNav.module.css`). O layout replica o template Xtreme: topbar escura com busca/ícones, logo textual “PAINELADM” e chip do usuário (dropdown simples com “Sair”); a etiqueta de seção ao lado da marca aparece fora do Dashboard para sinalizar a seção atual. A sidebar é uma faixa fixa na esquerda mostrando só ícones quando fechada (sem header) e, com o cartão de usuário removido, o primeiro bloco visível é a navegação. Não há LavaLamp nem provedores de tema; o visual é fixo em tons claros/azul.
- Temas e dependências removidos: `AdminThemeProvider`, `admin-theme.css`, contexto de filiais e todo o mini design system (`@components/ui`) seguem desativados. Inputs/cartões são estilizados diretamente nos módulos CSS do shell e das páginas.
- Dashboard (`/admin`): gráfico interativo com filtros de período/métrica e troca entre linhas, velas e pizza (toggle no header), agora maior e centralizado, com legenda “Agendados/Confirmados” abaixo do gráfico e pontos clicáveis para detalhar o dia. O filtro de período agora cobre 7/15/30/60/90 dias, “Todo” e “Personalizado” (datas inicial/final), e a seleção de período refaz a consulta para refletir os agendamentos reais; fallback estático permanece apenas em caso de erro. Mantém cards de atividades, tabela de clientes e tickets recentes. Usa Supabase (`appointments` e `profiles` role client).
- Agendamentos (`/admin/agendamentos`): calendário mensal por filial atribuída (admins) ou selecionável futuramente (super/master); o calendário usa cores de lotação (livre/parcial/lotado/passado), legenda centralizada e o seletor de mês agora fica no rodapé do card. O grid do calendário está mais compacto, com dia/semana centralizados e sem exibir dias de outros meses. Ao clicar em um dia o painel ao lado mostra todos os horários daquele dia com scroll interno (substituindo o card de lembretes/próximos atendimentos). A tabela cronológica exibe **status** e **serviço**, aceita todos os status e ganhou filtro por dropdown (“Próximos”, “Todos”, “Confirmados”, “Pendentes”, “Cancelados”, “Finalizados”), mantendo ordem por data e horário; cabeçalhos/conteúdo seguem centralizados. As métricas e a distribuição mensal ocupam metades iguais da largura: à esquerda ficam seis cartões por período (agendamentos em aberto, confirmados/reservados, pendentes, cancelados, reembolsados e concluídos) e à direita fica um gráfico de pizza preenchido e centralizado, com legenda em grid 3x2 alinhada por colunas e itens empilhados (nome com valor abaixo). O seletor de período usa labels compactos (7D/30D/90D/1A/total/P) em uma faixa horizontal de largura total. O filtro adicional abre um menu em camadas (total/serviços/técnicas → lista de serviços ou técnicas com opção de voltar), atualizando a legenda conforme o tipo escolhido. Dados filtram por `branch_id` quando houver vínculo; sem seleção, super/master podem ver todas as filiais permitidas pela RLS.
- Filiais (`/admin/filiais`): página exclusiva de super e master para criar filiais e listar apenas as criadas/atribuídas (super) ou todas (master). O topo traz dois cartões lado a lado e de mesmo tamanho: à esquerda o formulário de criação (campos empilhados: nome, região, status, foco) e à direita o painel de edição com lista simples de filiais, botões de editar/excluir e formulário inline que substitui a lista. Salvar mostra aviso de sucesso e volta para a lista atualizada; cancelar retorna sem alterar. A tabela abaixo continua exibindo membros ativos por nível, contadores de clientes/serviços e status. Selecionar uma linha abre um carrossel com os vinculados (avatar placeholder, nome, badge de role e botão de remover que usa o desvínculo existente). Campos de texto usam `box-sizing: border-box` para manter o espaçamento simétrico dentro dos cartões sem vazar para a direita.
- Rotas e permissões: rotas antigas `/filiais`, `/servicos`, `/tipos`, `/clientes`, `/configuracoes`, `/suporte`, `/admin/adminsuper` e `/admin/adminmaster` permanecem removidas. `useAdminGuard` aceita `admin`/`adminsuper`/`adminmaster`; login e menu direcionam para `/admin` e o nav lateral agora inclui links diretos para `/admin/agendamentos` e `/admin/filiais`.
- Responsividade: desktop a partir de 900px (sidebar colada no topo com a mesma cor da topbar, avatar visível mesmo recolhida; clique fora/na navegação recolhe a lateral). Item ativo fica encaixado na faixa e ícones inativos usam fundo médio mais claro. Abaixo de 900px vira drawer com backdrop; grades quebram para 1 coluna em telas estreitas, tabelas possuem scroll horizontal e cards/tickets/agendamentos mantêm margens/gaps consistentes.
- Navegação lateral: itens usam `box-sizing: border-box` para que padding e bordas não ultrapassem a faixa escura, mantendo o destaque azul contido em estados colapsado/expandido no mobile e desktop.
- Interação do shell admin: a sidebar recolhida mantém o mesmo padding/base do estado expandido e oculta metadados via transição de opacidade/visibilidade; ícones ancorados na mesma posição em ambos os estados e lista com `overflow: hidden` + labels `white-space: nowrap` para colapso estritamente horizontal; como não há cabeçalho de usuário, não existe bloco extra antes do menu.
- Nav items: padding/min-height/alinhamentos iguais para colapsado/expandido, ícones fixos em 38x38 sem encolher, labels/badges com `line-height: 1`/`align-self: center` para evitar aumento de altura ao revelar texto e colapso que apenas oculta texto/badges sem mexer no espaçamento.

## Cheat sheet (para PRs futuras)
- Shell padrão: `ClientPageShell`/`ClientSection` + vidro (`ClientGlassPanel`); `ClientSection` define padding top 64px, bottom 32px (mais safe-area) sem min-height forçada. Exceção `checkout` sem shell.
- `/procedimento`: sequência tipo → técnica → dia → horário; usa `useClientAvailability` com subscribe e filtros de buffer/duração; pagamento inicia via `/api/payments/create`.
- `/agendamentos`: filtros + paginação; pagar/cancelar/reagendar; `RescheduleModal` usa `useClientAvailability` (60 dias, buffer padrão) e `/api/slots`; respeita `CANCEL_THRESHOLD_HOURS`.
- `/meu-perfil`: edita perfil Supabase, avatar em `localStorage`, tema via CSS vars + `refreshPalette`; apenas admins alteram aparência.
- `/login`: lava + shell completo; formulário permanece visível enquanto verifica sessão; redirect pós-login envia qualquer role admin (`admin`/`adminsuper`/`adminmaster`) para `/admin` e demais para `/meu-perfil`.
- `/regras`: conteúdo direto no fundo sem glass; divisórias brancas e ornamento central devem permanecer.
- Riscos-chave: alterações em CSS vars/tema ou `useClientAvailability` impactam as rotas sensíveis; fluxos de pagamento e avatar seguem sem testes nem persistência server-side.
