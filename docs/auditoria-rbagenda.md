# Auditoria rbagenda

## 1. Visão geral da arquitetura de cliente
- Rotas de cliente vivem em `src/app/(client)` com páginas client-side. Layout padrão fornecido por `ClientPageLayout` (`ClientPageShell`, `ClientSection`, `ClientGlassPanel`) e `ClientFullScreenLayout` no layout de `(client)`. `checkout` é exceção: recebe só `LavaLampProvider`. `ClientPageShell` agora pode forçar a classe `force-motion` (com suporte a `#nomotion`) para centralizar o comportamento das animações.
- Vitrine `/catalogo` em `src/app/(client)/catalogo` usa o shell padrão (`ClientPageShell` + `ClientSection` + `ClientGlassPanel`) para listar opções ativas vindas de `services` + `service_type_assignments` + `service_photos`, assinando URLs do bucket `service-photos` antes de montar a galeria/capa. Os filtros de topo foram removidos: mesmo com múltiplas categorias, agora exibe apenas o badge/droplist da categoria ativa (abre dropdown quando houver mais de uma). Com uma única categoria, aplica-a automaticamente. Os cards mostram só o serviço principal (sem badge de categoria) e mantêm CTA para `/procedimento`, com grade mais larga no mobile, pouco respiro lateral e largura alinhada às páginas de agendamento.
- Fundo animado controlado por `LavaLampProvider` e variáveis CSS globais (`--bg-*`, `--inner-*`, `--glass`, `--glass-stroke`, `--card-stroke`, `--dark`, `--light`, `--lava-alpha-*`); `refreshPalette` redesenha blobs. Classes globais (`client-hero-wrapper`, `page`, `stack`, `glass`, `label`) estão em `globals.css` e agora definem padding vertical mais enxuto (topo 64px + safe-area, base 26px) com gaps menores.
- Páginas sensíveis: `/procedimento`, `/agendamentos`, `/meu-perfil` compartilham hero, vidro e tipografia; `/login` e `/regras` têm observações específicas abaixo. Estilos globais continuam focados em tokens/layout padrão e o que for específico de uma rota fica no CSS Module local.

## 2. Comportamento das páginas sensíveis
### 2.1 `/procedimento` (`src/app/(client)/procedimento/page.tsx`)
- **Objetivo**: fluxo completo de agendamento (tipo → técnica → dia → horário → criação de appointment + início do pagamento de sinal via Stripe).
- **Arquivos e componentes**: rota `page.tsx`; CSS `procedimento.module.css`; subcomponentes em `@components` (`TypeSelectionSection`, `TechniqueSelectionSection`, `DateSelectionSection`, `TimeSelectionSection`, `SummaryBar`, `SummaryModal`, `PayLaterNotice`, `AdminCustomizationPanel`, `ProcedimentoWrapper`, `ProcedimentoCard/Grid/Header`); tipos em `types.ts`.
- **Fluxo de dados/estado**: carrega sessão Supabase e catálogo (`service_types` + assignments + `services`), normaliza preços/duração/buffer. Usa `useClientAvailability` com `subscribe: true`, canal `procedimento-appointments`, buffer/timezone padrão e fallback por `buildAvailabilityData` se erro. Estados: seleção de tipo/técnica/dia/slot, controle de mês, flags de admin/hero, catálogo e modais (summary, pay later). A criação do appointment agora ocorre sob demanda (ao iniciar o pagamento do sinal ou ao aceitar o aviso de “Pagar depois”, e não mais no clique de Continuar) via `/api/appointments` com token; o depósito segue para `/api/payments/create` → `/checkout`; o aviso de “Pagar depois” exige confirmação (aceitar cria e envia para `/agendamentos`; cancelar reabre o resumo).
- **Layout e UX**: `ProcedimentoWrapper` agora usa `ClientPageShell` + `ClientSection` mantendo a transição `heroReady`; seções de tipo/técnica/dia/horário renderizadas via `ClientGlassPanel` com ícones `LashIcon`; legenda de calendário (available/booked/full/mine/disabled). A barra de resumo fixa foi removida: o resumo permanece apenas no modal acionado pelo botão principal da etapa de horário. Cada etapa ocupa quase a tela inteira (`min-height: calc(100vh - 200px)`) e o espaçamento/âncora entre seções foi ajustado para guiar o scroll com `scroll-margin-top: 140px`. Respeita `prefers-reduced-motion` e força `force-motion` salvo se removido manualmente. Modais de resumo/aviso usam `ClientModal` padronizado (vidro centralizado, título alinhado) para manter consistência visual. Os grids de tipo e técnica mantêm 2 colunas e agora possuem paginação 2x2 com setas acima do grid (indicador `página/total`), exibindo 4 cartões por vez sem alterar o design; selecionar um item leva a página correspondente e trocar o procedimento volta a página de técnicas para a primeira.
- **Organização**: modularizado em seções e tipos; lógica de disponibilidade isolada no hook; cálculo de slots local usando snapshot. Mantém padrão de outras páginas (shell + glass + lava).
- **Pontos fortes/fracos**: forte clareza do fluxo e reuso de hook; risco em ajustes do buffer/timezone/assinatura de `useClientAvailability` e na criação/pagamento distribuída. Falta testes e centralização de erros.
- **Recomendações**: extrair camada de serviço para pagamentos; validar slots no servidor; adicionar testes de integração para a cadeia tipo→técnica→slot; considerar reutilizar components de resumo em outros fluxos.

### 2.2 `/agendamentos` (`src/app/(client)/agendamentos/page.tsx`)
- **Objetivo**: listar agendamentos, filtrar por status, pagar sinal, cancelar e reagendar respeitando janela de segurança.
- **Arquivos e componentes**: rota `page.tsx`; CSS `agendamentos.module.css`; componentes `AppointmentsHeader`, `StatusFiltersBar`, `AppointmentsList`, `ConfirmCancelModal`, `RescheduleModal`, `BlockedModal`, `SuccessModal`; tipos em `types.ts`.
- **Fluxo de dados/estado**: requer sessão via `useClientSessionGuard` (redirect para `/login` se ausente). Busca `appointments` + `services`/`service_types` + `appointment_payment_totals`; normaliza valores e nomes. Estados de filtro/paginação (desktop 4 itens por página, mobile 3 via media query `max-width: 768px`), modais de pagamento/cancelamento/bloqueio/sucesso/edição e mensagens. `RescheduleModal` usa `useClientAvailability` (sem subscribe, filtrado por serviço, buffer/timezone padrão, fallback), busca slots via `/api/slots`, bloqueia hoje/passado e horários fora de `CANCEL_THRESHOLD_HOURS` (env ou 24h). Pagamento via `/api/payments/create` → `/checkout`; cancelamento via `/api/appointments/{id}/cancel`; reagendamento via `/api/appointments/{id}/reschedule`.
- **Layout e UX**: shell padrão com painel de vidro nos filtros e rodapé via `AppointmentsWrapper`; cards da lista exibem emoji de ferramenta, nome do procedimento e técnica com um bloco interno para detalhes em coluna (data, horário e valor) acompanhados de emojis. A grade agora é adaptativa: duas colunas em desktop e uma coluna em telas até 768px, mantendo a contagem de itens por página proporcional (4 no desktop, 3 no mobile) enquanto a paginação continua visível no rodapé. A lista de resultados não usa mais painel de vidro: o grid fica direto na página, aproveitando a largura máxima `min(1160px, 100%)` para cards mais largos. O bloco interno mantém o mesmo degradê/borda dos seletores de status. O sinal aparece na linha de valor (`(Sinal: R$X · status)`), sem badge separado. Ações de pagar/alterar/cancelar só aparecem quando o card está selecionado; o highlight de seleção reforça o foco. Modais usam `ClientModal` padronizado para backdrop/conteúdo consistentes (vidro degradê, botões alinhados) mantendo ícones e calendários locais. Calendário do modal marca `mine/full/booked/available` e, ao selecionar um dia, os horários são exibidos em um dropdown rolável em vez de chips individuais. O rodapé/mark da página está estilizado apenas no CSS Module (nada mais fica em `globals.css`). Contêineres `.page` e `.pageSection` replicam o layout do `/procedimento` para centralizar conteúdo e preservar o respiro do rodapé.
- **Organização**: fluxo dividido em componentes; lógica de disponibilidade encapsulada no hook. Mantém padrão estrutural do shell e redirecionamento de sessão agora feito via hook. Modais compartilham `BaseModal` para evitar duplicação.
- **Pontos fortes/fracos**: boa separação de UI vs. dados; risco em consistência de disponibilidade/buffer; pagamentos e cancelamentos distribuídos sem camada de serviço nem testes; lógica de janela de cancelamento replicada.
- **Recomendações**: unificar tratamento de erros e loading de pagamentos; validar cancelamento/reagendamento também no backend; adicionar testes de paginação e filtros; compartilhar componentes de badge/valor entre lista e modais.

### 2.3 `/meu-perfil` (`src/app/(client)/meu-perfil/page.tsx`)
- **Objetivo**: editar dados pessoais, senha, avatar local e preferências de tema/lava com navegação por badges internos.
- **Arquivos e componentes**: rota `page.tsx`; CSS `meu-perfil.module.css`; `ProfileHeader`, `ProfileForm`, `AvatarUploader`, `ThemePreferencesPanel`; tipos em `types.ts` (`Profile`, `ThemeState`, `defaultTheme`).
- **Fluxo de dados/estado**: `useProfileForm` (envolvendo `useClientSessionGuard`) carrega sessão/perfil (`profiles`), preenche campos e controla salvar/sair; a própria página também chama `useClientSessionGuard` para garantir proteção imediata. Avatar em `localStorage` (`rb_meu_perfil_avatar`). Painel de tema lê vars CSS (`--inner-*`, `--bg-*`, `--glass`, `--glass-stroke`, `--card-stroke`, `--dark`, `--light`, `--lava-alpha-*`), valida/normaliza, aplica via `setProperty` e chama `refreshPalette`; painel só aparece para perfis admin*. Usa `REVEAL_STAGE` para transições e mantém `force-motion`.
- **Layout e UX**: shell padrão com painel principal sem o wrapper `ClientGlassPanel`; a estrutura do perfil agora é renderizada diretamente no conteúdo da página (modelo similar ao `/regras`) mantendo o mesmo design interno (faixa verde, avatar/nome, tabs e cards internos). A faixa verde continua parte do card (pseudo-elemento) atrás do avatar/nome. Navegação principal segue em faixa rolável horizontal com scroll-snap (itens sem corte, centralizam no clique) preservando o visual premium, com scrollbar escondida via CSS. O conteúdo do formulário permanece dividido em cards internos por bloco (identificação, contato, segurança), reduzindo a sensação de formulário longo e melhorando o espaçamento vertical. CTA “Salvar alterações” mantém destaque visual e “Encerrar sessão” segue como ação secundária; edição de e-mail e senha exige clicar “Alterar” antes de abrir os campos editáveis. A rolagem segue o padrão do shell global (scroll do body), removendo contenção por 100dvh/overflow interno. A section do perfil deixou de usar `ClientSection`/`.center` e agora usa um wrapper local full-bleed com stack próprio para eliminar o recorte e encostar o card nas bordas, mantendo o conteúdo interno intacto.
- **Organização**: lógica de tema isolada no painel; tipos compartilhados; UI modular. Avatar permanece acoplado ao storage local.
- **Pontos fortes/fracos**: controles de cor completos e alinhados ao lava; risco de valores inválidos quebrando contraste; falta persistência remota do avatar e testes de validação de cor.
- **Recomendações**: validar cores com schema; salvar avatar no servidor; mover lógica de tema para hook compartilhado; cobrir fluxo de salvar perfil com testes e estados de erro.

### 2.4 `/login` (`src/app/(auth)/login/page.tsx`)
- **Objetivo**: autenticar usuário e redirecionar para o destino correto (painéis admin/adminsuper/adminmaster ou `/meu-perfil`).
- **Arquivos e componentes**: rota `page.tsx`; CSS `login.module.css`; usa `ClientPageShell`, `ClientSection`, `ClientGlassPanel` e `LavaLampProvider`.
- **Fluxo de dados/estado**: `supabase.auth.getSession` roda no mount para evitar flicker; se houver sessão, redireciona. `onAuthStateChange` mantém sync. Estados: email, password, msg, `loading`, `checkingSession`; `heroReady` vem de `useClientPageReady`. Enquanto `checkingSession` é true, o formulário permanece visível com aviso (evita “sumir” atrás de skeleton). Submit usa `signInWithPassword`; em sucesso chama `redirectByRole` que consulta `profiles.role` e envia para `/admin` (admin), `/admin/adminsuper` (adminsuper), `/admin/adminmaster` (adminmaster) ou `/meu-perfil` (demais), tratando ausência de sessão com aviso.
- **Layout e UX**: cartão “liquid glass” com logo em pílula, inputs com ícones, botão degradê e links de suporte/signup. Usa shell completo com lava; card centralizado.
- **Organização**: estado todo na página; lógica de sessão encapsulada em hooks Supabase; layout segue padrão de vidro.
- **Pontos fortes/fracos**: fluxo de sessão agora estável (formulário permanece visível); ainda falta feedback granular de erros Supabase e testes de autenticação.
- **Recomendações**: adicionar tratamento de erros por código; validar form antes de submit; mover redirecionamento por role para helper compartilhado.

### 2.5 `/regras` (`src/app/(client)/regras/page.tsx`)
- **Objetivo**: exibir regras públicas da agenda para usuários autenticados.
- **Arquivos e componentes**: rota `page.tsx`; CSS `regras.module.css`; subcomponentes locais em `@components` (`RulesHeader`, `RulesSectionList`, `RulesSectionCard`, `RulesSectionDivider`); tipos em `types.ts`.
- **Fluxo de dados/estado**: protegido por `useClientSessionGuard`; `heroReady` vem de `useClientPageReady`; classe `force-motion` aplicada via `ClientPageShell`.
- **Layout e UX**: usa `ClientPageShell` + `ClientSection` com classes locais (`wrapper`, `pageSection`) para herdar o esqueleto global de spacing/alinhamento, mas **não** usa `ClientGlassPanel`; conteúdo permanece direto no fundo com lava. Ornamento (flourish + diamond) e divisórias brancas entre cards foram preservados. Containers agora esticam a 100% da largura disponível (a lista de cards continua limitada a 720px) sem padding lateral extra, igualando o respiro das demais páginas do shell e evitando shrink-to-fit ou margens diferentes. Reforço de `word-break` evita truncamento em telas menores. O topo e o rodapé usam apenas o padding padrão do shell (64px/26px) sem min-height extra, evitando blocos de fundo vazio.
- **Organização**: modularizada em header, lista e cartões; array de regras tipado para facilitar manutenção sem alterar conteúdo.
- **Pontos fortes/fracos**: clareza visual mantida e alinhamento com padrão de autenticação. Risco baixo; depende apenas do Supabase para sessão.
- **Recomendações**: monitorar responsividade para garantir que textos longos continuem sem truncamento; manter ornamento e ausência de glass em futuros ajustes.

### 2.6 `/suporte` (`src/app/(client)/suporte/page.tsx`)
- **Objetivo**: centralizar canais de atendimento e chat próprio do suporte.
- **Arquivos e componentes**: rota `page.tsx`; CSS `suporte.module.css`; subcomponentes locais `SupportHeader`, `SupportChannelsList`, `SupportChat`, `SupportContent`; tipos em `types.ts`; novo schema Supabase (`support_threads`, `support_messages`).
- **Fluxo de dados/estado**: protegido por `useClientSessionGuard`; `heroReady` vem de `useClientPageReady`; classe `force-motion` aplicada pelo shell. `SupportChat` garante/abre thread ativo do usuário (`support_threads`), carrega histórico (`support_messages`) e insere novas mensagens do cliente enquanto atualiza `last_message_preview/last_actor` do thread.
- **Layout e UX**: usa `ClientPageShell` + `ClientSection` + `ClientGlassPanel` seguindo o mesmo respiro lateral das demais páginas (herdando o padding padrão do shell e a largura `clamp(320px, 92vw, 720px)` do vidro) sem forçar o `stack` a 100% de largura, evitando overflow lateral. Canais agora aparecem como três botões verticais, do mesmo tamanho e com profundidade (WhatsApp, e-mail e chat), cada um com emoji de ícone e sem CTA textual adicional; o botão do chat reutiliza o mesmo launcher do `SupportChat`. Alinhamentos internos foram centralizados e a tipografia dos cards foi uniformizada para evitar desnível do botão de Chat. O chat abre em um painel flutuante centralizado na tela, com opção de minimizar/fechar, balões com cores diferentes para cliente vs. suporte, área rolável e controles de anexo/emoji; o painel, a área de mensagens e o input usam superfícies sólidas arredondadas com borda suave para evitar translucidez no conteúdo. Quando aberto, o restante da tela escurece com um overlay; ao minimizar ou fechar, o fundo volta ao normal. Quando minimizado, renderiza apenas um botão flutuante circular com ícone e drag ativo (sem exibir o painel), mantendo o acesso rápido no mobile.
- **Interação do chat minimizado**: o botão minimizado captura o ponteiro durante o drag para manter o `pointermove` ativo fora do botão e tem `touch-action: none`/`user-select: none` para evitar scroll/seleção acidental ao arrastar.
- **Organização**: canais seguem array tipado; chat encapsula busca/criação de thread e inserção de mensagens com estados locais (`loading/sending`).
- **Recomendações**: adicionar respostas de staff/IA e deep-links de canais reais; considerar listener em tempo real e paginação de mensagens.

### 2.7 `/configuracoes` (`src/app/(client)/configuracoes/page.tsx`)
- **Objetivo**: permitir que a cliente ajuste preferências de contato/notificação.
- **Arquivos e componentes**: rota `page.tsx`; CSS `configuracoes.module.css`; usa `ClientPageShell` + `ClientSection` com header via `ClientPageHeader` e formulário simples.
- **Fluxo de dados/estado**: formulário controlado localmente; protegido por `useClientSessionGuard`; `heroReady` aplicado via hook.
- **Layout e UX**: card centralizado com badge, header padrão e lista de toggles estilizados localmente. Mantém fundo/padding do shell e aplica `force-motion` via shell.
- **Riscos**: mudanças de estilo não afetam lógica; guardar consistência das cores personalizadas nos inputs.

### 2.8 `/indice` (`src/app/(client)/indice/page.tsx`)
- **Objetivo**: hub rápido para links principais.
- **Arquivos e componentes**: rota `page.tsx`; CSS `indice.module.css`; usa `ClientPageShell` + `ClientSection` + `ClientPageHeader`.
- **Fluxo de dados/estado**: protegido por `useClientSessionGuard`; `heroReady` via hook; somente renderiza links estáticos.
- **Layout e UX**: badge + header padrão com cards de links em grade responsiva; vidro claro local nos cartões. Mantém `force-motion` pelo shell para animações consistentes.
- **Riscos**: baixos; apenas grid/responsividade.

### 2.9 `/catalogo` (`src/app/(client)/catalogo/page.tsx`)
- **Objetivo**: vitrine das opções do estúdio com fotos e valores estimados antes de agendar.
- **Arquivos e componentes**: rota `page.tsx`; CSS `catalogo.module.css`; usa `ClientPageShell` + `ClientSection` + `ClientGlassPanel` + `ClientPageHeader`; dados vêm diretamente de `supabase` (`services` + `service_type_assignments` + `service_photos`) com cálculo de preço/duração por `resolveFinalServiceValues`.
- **Fluxo de dados/estado**: protegido por `useClientSessionGuard`; carrega catálogo ao montar (`loading/error/ready`), normaliza assignments ativos e fotos ordenadas e gera URLs assinadas do bucket `service-photos` antes de renderizar a galeria/capa. Mantém apenas o seletor de categoria (badge com dropdown quando houver mais de uma); filtros de serviço e de destaques foram removidos. Quando só existe uma categoria, aplica-a automaticamente e a exibe como badge. O serviço principal mostrado no card prioriza a categoria ativa e, na ausência, o primeiro serviço da lista.
- **Layout e UX**: painel de vidro com grade responsiva (mín. 260px, gap menor no mobile e padding lateral reduzido) para deixar os cards mais largos. O bloco de categoria agora fica centralizado (label + badge alinhados no eixo horizontal), sem filtros no topo; a largura máxima do header e do painel está em `min(1160px, 100%)`, igualando o respiro lateral ao de `/agendamentos` e `/procedimento`. Cada card mostra apenas o badge do serviço principal alinhado à badge de contagem de fotos sobre a capa; clicar na capa ou na badge abre lightbox com navegação entre as fotos. CTA “Agendar” leva a `/procedimento`.
- **Riscos**: depende das policies do bucket de fotos para assinar URLs; se falhar, cai no path bruto. Filtros assumem que as categorias presentes nos serviços refletem as habilitadas na filial.
- **Layout e UX (atualização)**: badges de serviço e contagem de fotos agora ficam sobre a capa (z-index dedicado), todos os textos/CTAs/metadados foram centralizados horizontalmente e o bloco de valor/duração/sinal permanece em grade fixa 3x1 mesmo no mobile para manter a leitura em linha única.


## 3. Hooks e helpers compartilhados
- `useClientAvailability` (`src/hooks/useClientAvailability.ts`): recebe `serviceId`, `enabled`, `subscribe`, `channel`, `fallbackBufferMinutes`, `timezone`, mensagem de erro e `initialLoading`. Retorna snapshot de disponibilidade (dias, slots, busy intervals), loading, erro e `reloadAvailability`. Redireciona para `/login` sem sessão, busca `appointments` (status `pending/reserved/confirmed`) de 0–60 dias e inclui buffers por serviço; pode assinar Realtime para recarregar.
- `useClientPageReady` (`src/hooks/useClientPageReady.ts`): aplica classe `client-hero-ready` após mount para liberar animação do shell sem duplicar `useEffect` em cada página.
- `useProfileForm` (`src/app/(client)/meu-perfil/useProfileForm.ts`): carrega sessão/perfil, controla campos, submit e sign-out do `/meu-perfil` com validações compartilhadas.
- Tema/Lava: `useLavaLamp.refreshPalette` usado no painel admin de `/procedimento` e no painel de tema do `/meu-perfil`; `useLavaRevealStage` coordena transições (`heroReady`). Dependem de CSS vars globais.
- Layout: `ClientPageLayout` mantém grid `page`/`stack`, vidro e labels; `ClientFullScreenLayout` injeta header/rodapé; `/regras` é exceção sem painel de vidro. `ClientSection` agora é referência de espaçamento vertical com padding mais curto (64px no topo, 32px na base + safe-area) e sem min-height forçada; páginas que tinham padding próprio (ex.: `/regras`, `/suporte`) herdaram o padrão para alinhar o hero e reduzir fundo vazio.

## 4. Riscos, pontos fracos e oportunidades
- `useClientAvailability` é ponto crítico para `/procedimento` e reagendamento; mudar status/buffer/timezone ou remover redirecionamento pode quebrar slots ou segurança de janela.
- Tema depende de variáveis globais; valores inválidos afetam lava e contraste das páginas sensíveis.
- Fluxo de pagamento (Stripe) é chamado diretamente dos componentes; falta camada de serviço e testes de erro.
- Avatar somente local; risco de perda em novos dispositivos.
- Shell e classes globais são dependências fortes; alterações em `globals.css` impactam todas as páginas.

## 5. Atualizações recentes
- Perfil/Supabase: signup agora envia `full_name` e `whatsapp` como `user_metadata`; `/meu-perfil` lê primeiro da tabela `profiles` e, se não existir, cria/upserta com os metadados (incluindo e-mail) antes de preencher o formulário. A confirmação `/confirm` agora troca o código por sessão com `exchangeCodeForSession` e redireciona direto para `/meu-perfil`, garantindo e-mail sempre preenchido.
- Shell e spacing: padding vertical do shell reduzido (64px topo, 32px base + safe-area) e gaps menores na `.page`; `ClientSection` perdeu min-height forçada para evitar blocos de lava vazios em telas curtas.
- Painel admin: reconstruído do zero no template Xtreme (topbar escura, sidebar lateral fechada mostrando só ícones, cards brancos). Agora existem `/admin` e `/admin/agendamentos`: o primeiro mantém o gráfico com filtros, alternância de tipo (linhas/velas/pizza), atividades, clientes e tickets, enquanto o segundo traz calendário por filial, painel diário com horários ao lado, tabela cronológica e métricas de serviços/tipos (cartões de contagem + distribuição mensal em cartões separados). Não há tema alternável; a filial usada é a atribuída (admins) ou a selecionável futuramente (super/master).
- `/admin`: filtro de período do gráfico agora inclui 60/90 dias, “Todo” e “Personalizado” com datas inicial/final.
- Viewport global: `src/app/layout.tsx` define `viewport` com `width: device-width` e `initialScale: 1`, mantendo os `themeColor` originais para light/dark.
- `/procedimento`: wrapper agora usa `ClientPageShell` + `ClientSection` mantendo hero, sem alterar fluxo ou glass existente, e removeu min-heights/padding duplicados do módulo local. Espaço vertical entre as etapas (tipo → técnica → dia → horário) passou a usar `margin-top` progressiva para separar visualmente cada bloco. Cada seção agora tem altura mínima quase cheia (`min-height: calc(100vh - 200px)`) e âncoras uniformes (`scroll-margin-top: 140px`) para navegação suave.
- `/agendamentos`: redirecionamentos de sessão via `router.replace` (sem reload) mantendo modais/lista; wrapper local sem min-height extra e rodapé/mark agora estilizado apenas no CSS Module (classe global removida). Layout da `.pageSection`/`.page` alinhado ao `/procedimento` para centralizar cartões e dar respiro idêntico ao footer. A grade de cards usa duas colunas fixas em todos os breakpoints (removido o fallback para coluna única em <720px), exibindo os cinco itens paginados como 2x2 + sobra quando houver espaço mesmo no mobile.
- `/meu-perfil`: extratos anteriores mantidos, agora sem min-height custom no wrapper para seguir o shell enxuto.
- `/login`: shell de cliente aplicado; `heroReady` agora via hook e `checkingSession` mostra aviso em vez de esconder o form, evitando flicker.
- Recuperação de senha: novas rotas `/forgot-password` e `/reset-password` usam o mesmo shell/lava das telas de auth. A primeira envia `resetPasswordForEmail` com `redirectTo` para `/reset-password` e exibe confirmação inline; a segunda valida a sessão gerada pelo link, aplica validações básicas (mínimo de 8 caracteres e conferência) e usa `updateUser` para salvar a nova senha antes de direcionar para o login.
- `/admin/agendamentos`: distribuição mensal ajustada com pizza preenchida centralizada, legenda com itens centralizados e quebra automática, filtros em camadas (total/serviços/técnicas → lista + voltar) e labels compactos de período (7D/30D/90D/1A/total/P).
- `/admin/agendamentos`: legenda da distribuição agora usa grid 3x2 alinhada em colunas, garantindo que os itens inferiores (cancelados/reembolsados/concluídos) fiquem verticalmente alinhados aos superiores.
- `/admin/agendamentos`: faixa horizontal para seleção de período agora ocupa toda a largura do card, métricas em grade fixa 2x3, legenda da distribuição exibe valores abaixo do nome e tabela cronológica centralizada. O calendário foi compactado para blocos menores e agora exibe apenas dias do mês atual.
- `/regras`: reforço de quebra de linha para evitar truncamento mantendo ornamentos/divisórias. Padding próprio removido e espaçamento final reduzido para alinhar início do hero ao padrão do shell. Wrapper e section agora usam classes locais (`wrapper`, `pageSection`) para herdar o layout global (cor/centragem) sem mover ornamentos ou vidro. O container principal deixa de limitar a 960px e passa a ocupar 100% da largura disponível, mantendo apenas o limite de 720px na lista de cards para preservar legibilidade.
- `/suporte`: agora protegido por sessão, usa shell completo (lava + glass) e abre com `ClientPageHeader` para alinhar hero e tipografia. Canais modularizados em lista com tipos locais e sem padding custom na section (usa apenas o `ClientSection`). Subtítulo/ajustes visuais vivem no CSS Module. O card de suporte herda a largura do vidro global (clamp 320–720px) e o respiro lateral passa a ser o mesmo das outras páginas do shell, sem sobrescrever largura do stack. O painel do chat passou a abrir centralizado na tela, enquanto o modo minimizado mantém apenas o botão flutuante circular com drag ativo.
- `/suporte`: painel do chat e área de mensagens agora usam superfícies opacas (sem blur/transparência) para manter o conteúdo totalmente sólido.
- `/suporte`: botão minimizado do chat agora captura ponteiro no drag e bloqueia scroll/seleção durante o arraste para manter o movimento mesmo fora do botão.
- `/suporte`: chat expandido agora usa o mesmo overlay translúcido dos modais de procedimentos/agendamentos (rgba(16, 32, 25, 0.5) com blur de 6px), escurecendo o fundo de forma consistente; mensagens/input ganharam bordas arredondadas com contorno suave e profundidade (sombra externa + leve brilho interno); botão enviar recebeu sombra para profundidade.
- `/suporte`: botões de ação do cabeçalho do chat (minimizar/fechar) e ferramentas de input (anexo/emoji) ganharam gradiente e sombra leve para dar profundidade consistente com os demais controles.
- `/suporte`: canais de WhatsApp, e-mail e chat foram unificados em três botões verticais com ícones (emoji) e mesma largura/profundidade; o botão de chat agora reutiliza o launcher principal em vez de um CTA separado.
- `/suporte`: alinhamento interno dos cards de canal centralizado e tipografia dos textos equalizada para deixar o botão de Chat no mesmo tamanho dos demais; textos dos cards forçados a alinhar à esquerda para manter consistência.
- Sessão e shell: páginas protegidas usam `useClientSessionGuard` + `useClientPageReady`, eliminando `getSession` duplicado e padronizando a liberação do hero.
- Modais de cliente: `ConfirmCancelModal`, `BlockedModal`, `SuccessModal`, `RescheduleModal`, `SummaryModal` e `PayLaterNotice` agora usam `ClientModal` em `src/components/client` (vidro degradê centralizado, título alinhado e botões consistentes), eliminando estruturas locais duplicadas.
- Fluxo “Pagar depois”: o botão abre um aviso de pendência (prazo de 2h para pagar o sinal); aceitar cria o agendamento e redireciona para `/agendamentos`, cancelar reabre o resumo. A criação do appointment passou a acontecer apenas no pagamento do sinal ou nessa confirmação (não mais no clique de Continuar).
- Vidro e variáveis: `agendamentos.module.css` passou a usar apenas variáveis globais (`--ink`, `--muted`, `--card-stroke`, `--glass-stroke`, `--radius-*`) e removeu o bloco `:root` local para manter consistência temática.
- Estrutura `/agendamentos`: página encapsulada por `AppointmentsWrapper` (shell + section) para espelhar o padrão do `/procedimento`, agora com largura máxima de `min(1160px, 100%)` na área central. A lista deixou o painel de vidro externo para que o grid ocupe toda a largura disponível. Cards de agendamento ganharam avatar/emoji, painel interno de detalhes empilhados com emojis e badge de sinal na linha de valor; botões de ação agora dependem da seleção do card para evitar poluição visual.
- Reagendamento: seleção de horário no modal de reagendamento agora acontece via dropdown com rolagem, substituindo a grade de botões.
- `/procedimento`: seções principais (tipo, técnica, dia, horário) agora usam `ClientGlassPanel` em vez de divs de vidro locais mantendo rótulos e espaçamento; `SummaryModal` passou a usar o `ClientModal` padronizado.
- `/meu-perfil`: página também invoca `useClientSessionGuard` diretamente, garantindo proteção além do hook interno do formulário.
- Perfil: lógica de formulário centralizada em `useProfileForm`, mantendo a página focada no layout e temas.
- Força de animação: `ClientPageShell` passou a controlar `force-motion` (com hash `#nomotion`), removendo effects duplicados em `/regras`, `/suporte`, `/meu-perfil` e `/procedimento`.
- `/configuracoes` e `/indice`: agora usam `ClientPageShell` + `ClientSection`, headers padronizados (`ClientPageHeader`), guard de sessão e CSS Modules dedicados.
- Signup: ganhou shell/lava (`ClientPageShell` + `LavaLampProvider`), `ClientGlassPanel` e CSS Module (`signup.module.css`) para alinhar visualmente ao login, mantendo lógica intacta.
- Organização: `rules.module.css` renomeado para `regras.module.css`; criado barrel exports em `agendamentos/@components`, `procedimento/@components` e `regras/@components`; novos CSS Modules (`indice.module.css`) e ajustes no `configuracoes.module.css` para centralizar estilos locais.

## 6. Área administrativa
- Estrutura: rotas vivas (`/admin`, `/admin/agendamentos`, `/admin/categorias`, `/admin/servicos`, `/admin/opcoes`, `/admin/clientes` + `/admin/clientes/[clientId]`, `/admin/tickets` + `/admin/tickets/[threadId]`) sob o shell `AdminShell` + `AdminNav` (`adminShell.module.css`, `adminNav.module.css`). O layout replica o template Xtreme: topbar escura com busca/ícones, logo textual “PAINELADM” e chip do usuário (dropdown simples com “Sair”); a etiqueta de seção ao lado da marca aparece fora do Dashboard para sinalizar a seção atual. A sidebar é uma faixa fixa na esquerda mostrando só ícones quando fechada (sem header) e, com o cartão de usuário removido, o primeiro bloco visível é a navegação. Não há LavaLamp nem provedores de tema; o visual é fixo em tons claros/azul.
- Temas e dependências removidos: `AdminThemeProvider`, `admin-theme.css`, contexto de filiais e todo o mini design system (`@components/ui`) seguem desativados. Inputs/cartões são estilizados diretamente nos módulos CSS do shell e das páginas.
- Dashboard (`/admin`): gráfico interativo com filtros de período/métrica e troca entre linhas, velas e pizza (toggle no header), agora maior e centralizado, com legenda “Agendados/Confirmados” abaixo do gráfico e pontos clicáveis para detalhar o dia. O filtro de período agora cobre 7/15/30/60/90 dias, “Todo” e “Personalizado” (datas inicial/final), e a seleção de período refaz a consulta para refletir os agendamentos reais; fallback estático permanece apenas em caso de erro. Mantém cards de atividades, tabela de clientes e tickets recentes. Usa Supabase (`appointments` e `profiles` role client).
- Agendamentos (`/admin/agendamentos`): calendário mensal por filial atribuída (admins) ou selecionável futuramente (super/master); o calendário usa cores de lotação (livre/parcial/lotado/passado), legenda centralizada e o seletor de mês agora fica no rodapé do card. O grid do calendário está mais compacto, com dia/semana centralizados e sem exibir dias de outros meses. Ao clicar em um dia o painel ao lado mostra todos os horários daquele dia com scroll interno (substituindo o card de lembretes/próximos atendimentos). A tabela cronológica exibe **status** e **serviço**, aceita todos os status e ganhou filtro por dropdown (“Próximos”, “Todos”, “Confirmados”, “Pendentes”, “Cancelados”, “Finalizados”), mantendo ordem por data e horário; cabeçalhos/conteúdo seguem centralizados. As métricas e a distribuição mensal ocupam metades iguais da largura: à esquerda ficam seis cartões por período (agendamentos em aberto, confirmados/reservados, pendentes, cancelados, reembolsados e concluídos) e à direita fica um gráfico de pizza preenchido e centralizado, com legenda em grid 3x2 alinhada por colunas e itens empilhados (nome com valor abaixo). O seletor de período usa labels compactos (7D/30D/90D/1A/total/P) em uma faixa horizontal de largura total. O filtro adicional abre um menu em camadas (total/serviços/técnicas → lista de serviços ou técnicas com opção de voltar), atualizando a legenda conforme o tipo escolhido. Dados filtram por `branch_id` quando houver vínculo; sem seleção, super/master podem ver todas as filiais permitidas pela RLS.
- Filiais (`/admin/filiais`): página exclusiva de super e master para criar filiais e listar apenas as criadas/atribuídas (super) ou todas (master). O topo traz dois cartões lado a lado e de mesmo tamanho: à esquerda o formulário de criação (campos empilhados: nome, região, status, foco) e à direita o painel de edição com lista simples de filiais, botões de editar/excluir e formulário inline que substitui a lista. Salvar mostra aviso de sucesso e volta para a lista atualizada; cancelar retorna sem alterar. A tabela abaixo continua exibindo membros ativos por nível, contadores de clientes/serviços e status. Selecionar uma linha abre um carrossel com os vinculados (avatar placeholder, nome, badge de role e botão de remover que usa o desvínculo existente). Campos de texto usam `box-sizing: border-box` para manter o espaçamento simétrico dentro dos cartões sem vazar para a direita. A lista de filiais agora traz atalho “Categorias” que leva para `/admin/filiais/[id]/categorias`, onde super/master habilitam categorias ativas por filial (checkboxes salvos em `branch_service_categories`).
- Categorias (`/admin/categorias`): CRUD de categorias (tabela `service_categories`) com campos nome/slug/descrição/ordem/ativo. Apenas adminsuper/adminmaster podem criar/editar/excluir; admins comuns têm visão somente leitura. Lista em tabela ordenada e formulário dedicado, ambos no estilo de cartões brancos.
- Tickets (`/admin/tickets` + `/admin/tickets/[threadId]`): listagem de `support_threads` ordenada por `updated_at` desc com filtros de status (todos/abertos/escalados/fechados) e busca por nome, e-mail, prévia ou id. Cada card exibe cliente (nome/email), status (badge por estado), prévia de mensagem, último ator (`user/staff/assistant`) e atalho “Abrir”. A tela de detalhe reutiliza `SupportThreadView` (compartilhada com `/admin/suporte/[threadId]`), carregando `support_messages` e permitindo enviar resposta que atualiza `last_message_preview/last_actor/updated_at`.
- Clientes (`/admin/clientes` + `/admin/clientes/[clientId]`): a listagem deriva o escopo de clientes a partir de `appointments` respeitando RLS por filial (`can_access_branch`), agregando últimos agendamentos, contagem e filiais tocadas (até 1000 registros) e depois buscando os perfis (`profiles` role `client`). Filtros locais permitem selecionar filial, buscar por nome/e-mail e restringir a clientes com agendamentos; cards exibem avatar, e-mail, último agendamento, contagem e badge de filiais com link “Abrir”. A página de detalhe mostra dados básicos (nome, e-mail, WhatsApp, desde) e os 20 agendamentos mais recentes visíveis, com filial, valor e status; se o admin não tiver agendamentos no escopo, exibe empty state.
- Serviços (`/admin/servicos`): gestão de `service_types` com dropdown para associar cada serviço a uma categoria ativa (`category_id`). Visualização agrupa serviços por categoria, mostra status, slug, filial e opções vinculadas (`service_type_assignments` → `services`), inclui alerta de “serviços sem opções” e oferece atalho “Gerenciar Opções” que abre `/admin/opcoes` filtrado. Apenas super/master podem salvar; admins comuns ficam em modo leitura. Opções permanecem vinculadas via assignments existentes.
- Opções (`/admin/opcoes` + rotas dedicadas): CRUD de `services` focado em metadados (nome, slug, descrição, ativo) e vínculos obrigatórios com `service_types`. Valores finais (duração/preço/sinal/buffer) seguem padrão do serviço ou override em `service_type_assignments`. A lista de opções é isolada em `/admin/opcoes`, com filtros integrados no topo do card, ações de editar (`/admin/opcoes/[id]/editar`), personalizar (`/admin/opcoes/[id]/personalizar`) e excluir (remove a opção e vínculos). Criação/edição usam cartões únicos em `/admin/opcoes/nova` e `/admin/opcoes/[id]/editar`: seções A) dados + fotos, B) serviços obrigatórios (checklist com busca/filtro), C) configuração por serviço com toggle “usar padrão” e overrides finais; submit bloqueia sem serviço selecionado. Personalização final fica em `/admin/opcoes/[id]/personalizar`, exibindo apenas os serviços já vinculados e permitindo override sem expor dados básicos. A listagem traz cabeçalho com categoria (sem slug) e abre um overlay ancorado ao card (via portal) para mostrar vínculos/ações sem alterar a altura do grid, mantendo destaque visual no card ativo. Galeria de fotos permanece em `service_photos` (upload, remover, ordenar) apenas após salvar. Admins continuam somente leitura; super/master editam. Navegação lateral mantém item dedicado “Opções”.
- Opções (`/admin/opcoes` + rotas dedicadas): CRUD de `services` focado em metadados (nome, slug, descrição, ativo) e vínculos obrigatórios com `service_types`. Valores finais (duração/preço/sinal/buffer) seguem padrão do serviço ou override em `service_type_assignments`. A lista de opções é isolada em `/admin/opcoes`, com filtros integrados no topo do card, ações de editar (`/admin/opcoes/[id]/editar`), personalizar (`/admin/opcoes/[id]/personalizar`) e excluir (remove a opção e vínculos). Criação/edição usam cartões únicos em `/admin/opcoes/nova` e `/admin/opcoes/[id]/editar`: seções A) dados + fotos, B) serviços obrigatórios (checklist com busca/filtro), C) configuração por serviço com toggle “usar padrão” e overrides finais; submit bloqueia sem serviço selecionado. Personalização final fica em `/admin/opcoes/[id]/personalizar`, exibindo apenas os serviços já vinculados e permitindo override sem expor dados básicos. A listagem agora traz cabeçalho com categoria (sem slug), badge de serviços vinculados clicável e seta de expansão; clicar no card/badge/seta abre um overlay ancorado ao card (via portal) com os vínculos e ações sem alterar a altura do grid, mantendo destaque visual no card ativo. Galeria de fotos permanece em `service_photos` (upload, remover, ordenar) apenas após salvar. Admins continuam somente leitura; super/master editam. Navegação lateral mantém item dedicado “Opções”.
- Serviços (`/admin/servicos` + rotas dedicadas): listagem isolada com filtros de nome, categoria e status, opção de agrupar por categoria e chips das opções vinculadas; ações direcionam para editar (`/admin/servicos/[id]/editar`), excluir e gerenciar opções (link para `/admin/opcoes?servico=id`). Criação e edição migraram para páginas próprias (`/admin/servicos/novo` e `/admin/servicos/[id]/editar`) com formulário único de campos (nome, slug, categoria, padrões de duração/preço/sinal/buffer, descrição e ativo) mantendo a mesma lógica de banco e vínculos.
- Rotas e permissões: rotas antigas `/filiais`, `/servicos`, `/tipos`, `/clientes`, `/configuracoes`, `/suporte`, `/admin/adminsuper` e `/admin/adminmaster` permanecem removidas. `useAdminGuard` aceita `admin`/`adminsuper`/`adminmaster`; login e menu direcionam para `/admin` e o nav lateral agora inclui links diretos para `/admin/agendamentos` e `/admin/filiais`.
- Responsividade: desktop a partir de 900px (sidebar colada no topo com a mesma cor da topbar, avatar visível mesmo recolhida; clique fora/na navegação recolhe a lateral). Item ativo fica encaixado na faixa e ícones inativos usam fundo médio mais claro. Abaixo de 900px vira drawer com backdrop; grades quebram para 1 coluna em telas estreitas, tabelas possuem scroll horizontal e cards/tickets/agendamentos mantêm margens/gaps consistentes.
- Navegação lateral: itens usam `box-sizing: border-box` para que padding e bordas não ultrapassem a faixa escura, mantendo o destaque azul contido em estados colapsado/expandido no mobile e desktop.
- Interação do shell admin: a sidebar recolhida mantém o mesmo padding/base do estado expandido e oculta metadados via transição de opacidade/visibilidade; ícones ancorados na mesma posição em ambos os estados e lista com `overflow: hidden` + labels `white-space: nowrap` para colapso estritamente horizontal; como não há cabeçalho de usuário, não existe bloco extra antes do menu.
- Nav items: padding/min-height/alinhamentos iguais para colapsado/expandido, ícones fixos em 38x38 sem encolher, labels/badges com `line-height: 1`/`align-self: center` para evitar aumento de altura ao revelar texto e colapso que apenas oculta texto/badges sem mexer no espaçamento. Item “Clientes” agora aponta para `/admin/clientes` e “Tickets” segue como link ativo (badge “Em breve” removida).

## Cheat sheet (para PRs futuras)
- Shell padrão: `ClientPageShell`/`ClientSection` + vidro (`ClientGlassPanel`); `ClientSection` define padding top 64px, bottom 32px (mais safe-area) sem min-height forçada. Exceção `checkout` sem shell.
- `/procedimento`: sequência tipo → técnica → dia → horário; usa `useClientAvailability` com subscribe e filtros de buffer/duração; pagamento inicia via `/api/payments/create`.
- `/agendamentos`: filtros + paginação; pagar/cancelar/reagendar; `RescheduleModal` usa `useClientAvailability` (60 dias, buffer padrão) e `/api/slots`; respeita `CANCEL_THRESHOLD_HOURS`.
- `/meu-perfil`: edita perfil Supabase, avatar em `localStorage`, tema via CSS vars + `refreshPalette`; apenas admins alteram aparência.
- `/login`: lava + shell completo; formulário permanece visível enquanto verifica sessão; redirect pós-login envia qualquer role admin (`admin`/`adminsuper`/`adminmaster`) para `/admin` e demais para `/meu-perfil`.
- `/regras`: conteúdo direto no fundo sem glass; divisórias brancas e ornamento central devem permanecer.
- Riscos-chave: alterações em CSS vars/tema ou `useClientAvailability` impactam as rotas sensíveis; fluxos de pagamento e avatar seguem sem testes nem persistência server-side.
